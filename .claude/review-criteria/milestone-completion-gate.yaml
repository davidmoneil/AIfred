# Milestone Completion Gate — Mandatory Pre-Completion Requirements
#
# ENFORCEMENT LEVEL: BLOCKING
# This gate MUST pass before any milestone can be marked complete.
#
# IMPORTANT: This file does NOT hardcode document paths.
# All document paths are sourced from: .claude/planning-tracker.yaml
# This gate defines the LOGIC; planning-tracker.yaml defines the DOCUMENTS.
#
# Version: 1.1.0
# Created: 2026-01-23
# Updated: 2026-01-23 (Removed hardcoded paths, reference planning-tracker.yaml)

version: 1.1.0
created: 2026-01-23
updated: 2026-01-23

# =============================================================================
# SOURCE OF TRUTH
# =============================================================================
# All document paths come from planning-tracker.yaml
# This gate NEVER hardcodes file paths — it references the tracker.
#
# To add/remove documents from gate checks:
#   1. Edit .claude/planning-tracker.yaml
#   2. Add document to planning[] or progress[] sections
#   3. Set enforcement: mandatory
#   4. Gate automatically picks up the change
# =============================================================================

source_of_truth: .claude/planning-tracker.yaml

gate:
  name: milestone_completion
  enforcement: blocking  # blocking | warning | advisory
  description: "Verify all planning and progress documents are updated before milestone sign-off"

# =============================================================================
# REQUIRED CHECKS (ALL must pass)
# =============================================================================
# Document targets are resolved dynamically from planning-tracker.yaml

required_checks:

  # 1. Planning Document Checkboxes
  - id: planning_checkboxes
    name: "Planning document checkboxes updated"
    description: "Milestone-related checkboxes in planning docs are marked complete"
    enforcement: mandatory
    source:
      file: planning-tracker.yaml
      section: planning
      filter: "enforcement == 'mandatory' AND scope IN active_scopes"
    verification:
      type: file_content
      check: "Checkbox count increased OR milestone items marked [x]"
    on_fail: "Block completion, list unchecked items from matched documents"

  # 2. Progress Document Entry Written
  - id: progress_entry
    name: "Progress document entry written for milestone"
    description: "Progress docs (chronicle) have complete entry with required sections"
    enforcement: mandatory
    source:
      file: planning-tracker.yaml
      section: progress
      filter: "enforcement == 'mandatory' AND scope IN active_scopes"
    verification:
      type: file_content
      check: "Milestone N section exists with required_sections from tracker"
    on_fail: "Block completion, prompt for progress doc update"

  # 3. Session State Updated
  - id: session_state
    name: "Session state reflects completion"
    description: "session-state.md shows milestone work in 'What Was Done'"
    enforcement: mandatory
    source:
      file: planning-tracker.yaml
      section: always_review
      filter: "path CONTAINS 'session-state'"
    verification:
      type: file_modified
      check: "Modified today AND contains reference to completed milestone"
    on_fail: "Block completion, prompt for session state update"

  # 4. AC-03 Review (Optional but Recommended)
  - id: ac03_review
    name: "AC-03 Milestone Review passed"
    description: "Formal milestone review completed with passing scores"
    enforcement: recommended  # Can be skipped with reason
    verification:
      type: review_report
      target_pattern: ".claude/reports/reviews/{milestone}-review-*.md"
      check: "Report exists AND verdict = approved|conditional"
    on_skip: "Log reason, proceed with warning"

# =============================================================================
# GATE WORKFLOW
# =============================================================================

workflow:
  trigger_phrases:
    - "milestone complete"
    - "milestone done"
    - "M[0-9]+ complete"
    - "finished milestone"
    - "milestone [0-9]+ done"

  sequence:
    1: "Detect milestone completion signal"
    2: "Identify current scope from session-state.md"
    3: "Load planning-tracker.yaml"
    4: "Filter documents by scope"
    5: "Run required_checks in order"
    6: "If any mandatory check fails → BLOCK with specific remediation"
    7: "If recommended checks fail → WARN but allow proceed"
    8: "On all pass → Allow completion, log success"

  on_block:
    message: |
      ⛔ MILESTONE COMPLETION BLOCKED

      The following documentation updates are required before this milestone can be marked complete:

      {failed_checks}

      Please update the required documents and try again.

      Reference: .claude/review-criteria/milestone-completion-gate.yaml

    remediation_prompt: true  # Offer to help update docs

  on_pass:
    message: |
      ✅ Milestone Completion Gate PASSED

      All documentation requirements verified:
      - [ ] Planning checkboxes updated
      - [ ] Chronicle entry complete
      - [ ] Session state current

      Milestone may now be marked complete.

# =============================================================================
# SKIP PROTOCOL
# =============================================================================
# Gate can be skipped ONLY with explicit user approval and documented reason

skip_protocol:
  allowed: true
  requires:
    - explicit_user_confirmation: "Skip documentation gate? This is not recommended."
    - reason_provided: "Reason for skip will be logged"

  logging:
    file: ".claude/logs/gate-skips.jsonl"
    format: |
      {"timestamp": "{ISO8601}", "gate": "milestone_completion", "milestone": "{N}", "reason": "{user_reason}", "skipped_checks": [{check_ids}]}

# =============================================================================
# INTEGRATION POINTS
# =============================================================================

integrations:
  # Hook that triggers this gate
  trigger_hook: "milestone-doc-enforcer.js"

  # Pattern that defines documentation requirements
  documentation_pattern: "milestone-review-pattern.md"

  # Command that can manually trigger gate check
  manual_command: "/review-milestone --gate-only"

  # End-session integration
  end_session_check: true  # Also run at /end-session if milestone work detected
