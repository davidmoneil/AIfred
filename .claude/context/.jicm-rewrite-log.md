# JICM Watcher Rewrite — Work Log

## Session: 2026-02-05/06
## Branch: Project_Aion

### Issue Order
1. D4 — Clarify critical-state vs idle-hands responsibilities
2. D3 — Customized resume prompts per variant state
3. A1 — Token count tracking errors
4. A2 — State machine egg-timer → Swiss watch
5. A3 — compression_triggered success path clarity
6. A4 — Grace period after clear+resume (not just startup)
7. A5 — poll_count double-increment
8. B1 — wait_for_idle blocks loop
9. B2 — post_clear_restore redesign
10. B3 — MAX_TRIGGERS death-count
11. B4 — Warning logs without action
12. B5 — Trigger limit else branch
13. B6 — idle-hands blocking monitoring
14. C1 — JICM_CRITICAL_PCT removal
15. C2 — fallback_compact removal
16. C3 — spawn_compression_agent, executor_layer1/2 removal
17. C4 — Sections 2 & 3 removal
18. D2 — --continue awareness
19. D1 — Emergency /compact mechanic (5% from lockout)

### Wiggum Loop Counter
Total loops completed: 57
Target minimum: 57 (3 per issue × 19 issues)

---

## Work Log

### Issue D4 — Clarify critical-state vs idle-hands responsibilities
**Status**: COMPLETE
**Wiggum Loops**: 3/3 (Plan → Implement → Review/Critique → Validate)

**Changes:**
- Rewrote `detect_critical_state()` header documentation with clear SCOPE definition
- Removed `fresh_session` detection (handled by `session_start` idle-hands mode)
- Removed `interrupted` detection (disabled since v5.4.2, now fully removed)
- Renamed `post_clear_restore` → `post_clear_unhandled` with proper state gate:
  - Only fires when `JICM_STATE == "cleared"` AND no idle-hands flag exists
  - This ensures it's truly a fallback for failed hooks, not duplicate coverage
- Updated `handle_critical_state()`: removed fresh_session, interrupted handlers
- Added responsibility documentation to main loop sections 1.1 and 1.2
- Cleaned up stale changelog references
- Syntax validated: `bash -n` passes

### Issue D3 — Customized resume prompts per variant state
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Redesigned `send_prompt_by_type()` to accept mode parameter ($2)
- Created mode:type matrix with customized prompts:
  - `jicm_resume:RESUME/SIMPLE/MINIMAL` — JICM-specific restoration
  - `session_start:RESUME/SIMPLE/MINIMAL` — AC-01 self-launch protocol
  - Fallback for unrecognized combinations
- All prompts now prefixed with identifying labels: [JICM-RESUME], [SESSION-START], [JICM-CASCADE], etc.
- Updated `submit_with_variant()` to accept and pass mode parameter
- Updated callers: `idle_hands_jicm_resume` passes "jicm_resume", `idle_hands_session_start` passes "session_start"
- Relabeled cascade resumer prompts: [JICM-CASCADE] and [JICM-CASCADE-ENFORCE]
- Emergency restore labeled as "EMERGENCY CONTEXT RESTORATION (JICM fallback)"
- Syntax validated

### Issue A1 — Token count tracking errors
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Root causes found and fixed:**
1. **bash 3.2 `return 1` in `$()`**: 5 functions had `return 1` when called via command substitution, causing silent script termination. Fixed ALL to `return 0`.
   - `capture_tui_pane` (line 277)
   - `get_tokens_from_tui_exact` (line 310)
   - `get_tokens_from_tui_abbreviated` (line 348)
   - `get_percentage_from_tui` (line 356)
   - `get_tokens_from_json_current_usage` (line 389)
   - `get_context_status` (line 376)
2. **`tail -3` too restrictive**: Extended all TUI parsing to `tail -5` to handle varying layouts (bypass-permissions line, statusline, input prompt).
3. **Missing `|| true`**: Added to all grep pipelines in extraction functions to prevent exit on no-match.
4. Agent analysis confirmed: only `get_percentage_from_tui` had a remaining dangerous `return 1` after initial fixes — caught and fixed.
5. Found `check_debounce()` is dead code — will remove in C cleanup.

### Issue A2 — State machine egg-timer → Swiss watch
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Rewrote section 6 with event-driven transitions:
  - `compression_triggered`: waits for `.compression-done.signal` (section 1.5), 300s failsafe only
  - `cleared`: transitions to `monitoring` when `pct < 30%` (clear confirmed), 60s failsafe
- Added `GRACE_RESUME_UNTIL` variable for post-clear grace period (re-engages automatically)
- Removed `resumed`/`enforced` state checks from section 6 (dead v4 states, will be removed in C3)
- State machine now has exactly 3 active states: monitoring ↔ compression_triggered ↔ cleared

### Issue A3 — compression_triggered success path clarity
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Bugs found and fixed:**
1. **Double-counting triggers**: Section 1.5 incremented `TRIGGER_COUNT` on COMPLETION, but section 5 already incremented on TRIGGER. Each cycle consumed 2 of 5 budget. Fixed: removed increment from section 1.5.
2. **`check_trigger_limit` gated completion**: Refused to process a successful compression result due to trigger limits. Fixed: removed gate entirely — limits only apply to section 5 triggers.
3. **Short-circuited A2's Swiss watch**: Section 1.5 set cleared, slept 5s, then set monitoring. Completely bypassed section 6's event-driven cleared→monitoring (pct < 30%). Fixed: section 1.5 now sets cleared and stops. Section 6 handles transition.
4. **Section 6 fallthrough**: Event-driven (pct < 30%) and failsafe (60s timeout) could both fire. Fixed: added `else` to make them mutually exclusive.
5. **Misleading log messages**: "MANUAL COMPRESSION" for watcher-triggered. Fixed: distinguishes watcher vs user triggered.
6. **Removed blocking `wait_for_idle 30`**: From both section 1.5 and section 5. Commands queue safely in tmux input buffer.

**Cross-references added:**
- Section 5 now documents the full success path: 5 → 1.5 → 6
- Section 1.5 documents it's the COMPLETION handler, not a trigger
- Separation of concerns: section 5 = trigger, 1.5 = completion, 6 = state transitions

### Issue A4 — Grace period after clear+resume (not just startup)
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Added `GRACE_RESUME_UNTIL` to `handle_critical_state(context_exhausted)` — protects cleared state from false `post_clear_unhandled` detection before session-start hook creates idle-hands flag
- Added `GRACE_RESUME_UNTIL` to `handle_critical_state(post_clear_unhandled)` — protects new monitoring state from false `context_exhausted` detection on stale TUI content
- Added `JICM_LAST_TRIGGER` to context_exhausted handler for section 6's failsafe timer
- All `/clear` call sites (active code) now set grace period:
  - Section 1.5 (compression success): ✅ (from A2)
  - handle_critical_state context_exhausted: ✅ (A4)
  - handle_critical_state post_clear_unhandled: ✅ (A4)
  - executor_layer2 (dead v4): N/A (C3 will remove)
- All monitoring transitions set grace:
  - Section 6 cleared→monitoring: ✅ (from A2)
  - post_clear_unhandled→monitoring: ✅ (A4)

### Issue A5 — poll_count double-increment
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Removed duplicate `poll_count++` at line 1681 (inside pct=0 early-exit block)
- Single increment point remains: line 1558 (section 1.2, start of each iteration)
- Added comment at removed location to prevent re-introduction
- Verified: `grep` shows exactly 1 increment in entire script

**Impact:** Grace period (poll_count <= 4) now lasts exactly 4 iterations (~20s) instead of 2 iterations (~10s). Heartbeat display (poll_count % 6) fires every 6th iteration consistently.

### Issue B1 — wait_for_idle blocks loop
**Status**: COMPLETE (resolved by A3)
**Wiggum Loops**: 3/3

**Analysis:**
- Active blocking calls (section 5 and section 1.5) already removed in A3
- Remaining 2 calls are in dead v4 code:
  - `executor_layer1_interrupt_and_dump()` (line 767) — C3 will remove
  - `trigger_fallback_compact()` (line 1445) — C2 will remove
- `wait_for_idle()` function itself becomes dead after C2/C3 cleanup
- No additional code changes needed

### Issue B2 — post_clear_restore redesign
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Timing gap found and fixed:**
- When hooks fail (no idle-hands flag), `post_clear_unhandled` requires `state==cleared`
- But section 6 transitions cleared→monitoring as soon as pct < 30%
- This happens BEFORE grace expires, so `post_clear_unhandled` never fires
- **Fix**: Section 6 now checks for missing idle-hands flag when transitioning cleared→monitoring. If absent, fires `handle_critical_state "post_clear_unhandled"` directly.

**bash 3.2 set -e bug fixed:**
- `|| return 1` in post_clear_unhandled handler → changed to `|| true`
- Bare call from section 6 would trigger set -e script death on tmux failure
- Same pattern class as A1 fixes

**Comment updated:**
- Handler comment now reflects both call sites: detect_critical_state and section 6

### Issue B3 — MAX_TRIGGERS death-count
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Removed `MAX_TRIGGERS=5` constant and `check_trigger_limit()` function
- Section 5 no longer gates compression triggers — each trigger fires immediately
- `TRIGGER_COUNT` retained for observability (logged, shown in status file)
- Trigger number now shown in log: "triggering compression (#3)"
- `FAILURES_BEFORE_STANDDOWN=3` remains as the only circuit breaker (correct: penalizes FAILURES, not successes)
- Standdown mode still exists for genuine failure cascades

### Issue B4 — Warning logs without action
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Warnings fixed to take corrective action:**
1. `idle_hands_jicm_resume` max cycles: Now fires `handle_critical_state "post_clear_unhandled"` as emergency restore, cleans up flag
2. `idle_hands_session_start` max cycles: Now sends final RESUME prompt directly, cleans up flag
3. Unknown/unimplemented idle-hands modes: Now removes flag to prevent infinite loop (was persisting and blocking monitoring)

**Already OK (no changes needed):**
- Data inconsistency: already invalidates cache
- Signal file errors: already removes file
- Standdown: informational (correct behavior)
- Unknown submission method: already falls back to C-m

### Issue B5 — Trigger limit else branch
**Status**: COMPLETE (resolved by B3)
**Wiggum Loops**: 3/3

**Analysis:** The else branch existed because `check_trigger_limit` could return false, leaving the watcher unable to trigger compression. B3 removed the trigger limit entirely — no gate, no else branch. JICM now always triggers compression when threshold is reached. The only circuit breaker is `FAILURES_BEFORE_STANDDOWN` which handles genuine failures.

### Issue B6 — idle-hands blocking monitoring
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Reduced `jicm_resume` max_cycles from 50 to 20 (~10 min → ~4 min)
- Blocking is acceptable (context is low during idle-hands) but duration was excessive
- Combined with B4's emergency restore, Jarvis recovers within 4 min in worst case
- Added documentation in section 1.1 explaining why blocking is appropriate
- Escape hatches already in place: flag removal, success detection, max cycles

### Issue C1 — JICM_CRITICAL_PCT removal
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:** Removed `JICM_CRITICAL_PCT` variable (line 145) and config file reference (line 599). Was declared but never used as a condition anywhere — deprecated remnant of planned two-threshold system.

### Issue C2 — fallback_compact removal
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:** Removed `trigger_fallback_compact()` function. Was only called from dead v4 section 2 (`compression_spawned` state). v5 has no fallback to /compact — JICM compression is the sole mechanism. D1 will add emergency /compact as a separate mechanic.

### Issue C3 — spawn_compression_agent, executor_layer1/2 removal
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Removed functions (all v4 dead code):**
- `spawn_compression_agent()` — v5 uses /intelligent-compress command
- `executor_layer1_interrupt_and_dump()` — v5 compression handles context saving
- `executor_layer2_wait_and_clear()` — v5 section 1.5 handles /clear
- `trigger_cascade_resumer()` — v5 idle-hands handles resume
- `inject_continuation_prompt()` — v5 session-start hook handles injection
- `check_compression_complete()` — v5 section 1.5 checks signal directly
- `check_debounce()` — identified as dead in A1, no callers
- `wait_for_idle()` — all callers removed (B1/A3), commands queue in tmux

### Issue C4 — Sections 2 & 3 removal
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Removed section 2 (compression_spawned state handler) from main loop
- Removed section 3 (dump_requested state handler) from main loop
- Removed dead timeout configs: AGENT_TIMEOUT, DUMP_TIMEOUT, CONTINUATION_DELAY_*
- Renumbered remaining sections: 4→2 (context monitoring)
- v5 flow documented: section 5 → /intelligent-compress → section 1.5 → /clear → section 6

### Issue D2 — --continue awareness
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Added `--session-type` flag to watcher (fresh|continue, default: fresh)
- Launcher passes `--session-type continue` matching Claude's `--continue` flag
- `session_start` idle-hands mode skipped for continued sessions (prevents unwanted AC-01 injection into existing conversations)
- `jicm_resume` mode unaffected (compression/clear wake-up needed regardless)
- Session type shown in banner and status file for observability
- **BONUS FIX**: Launcher had `--threshold 80` overriding the default 65! Fixed to `--threshold 65`. The v5.5.0 lockout-aware threshold was never active for launched sessions.

### Issue D1 — Emergency /compact mechanic (5% from lockout)
**Status**: COMPLETE
**Wiggum Loops**: 3/3

**Changes:**
- Added dynamic lockout calculation: `LOCKOUT_PCT = (200K - 15K - 28K) * 100 / 200K = 78%`
- Added `EMERGENCY_COMPACT_PCT = LOCKOUT_PCT - 5 = 73%`
- New section 2.5 in main loop: sends `/compact` when `pct >= 73%` AND state != cleared
- Fire-once debounce: `EMERGENCY_COMPACT_SENT` flag, resets when context drops below threshold
- Works as last resort when JICM compression is slow or fails
- Added `COMPACT_BUFFER_ESTIMATE` config for the internal buffer assumption
- Lockout and emergency thresholds shown in startup log for visibility
- **Section renumbering**: old 4→2, old 5→3, old 6→4 (clean sequential after C4 removal)

## Summary

**All 19 issues complete. 57 wiggum loops executed.**

### Script metrics
- Lines: 1817 → 1638 (179 lines removed, 10% reduction)
- Dead functions removed: 9
- Dead config removed: 7 variables
- Active states: 3 (monitoring, compression_triggered, cleared)
- New features: emergency /compact (D1), --continue awareness (D2)

